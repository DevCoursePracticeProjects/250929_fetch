<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>포켓몬 도감</title>

    <!-- favicon -->
    <link rel="apple-touch-icon" sizes="180x180" href="./img/apple-touch-icon.png" />
    <link rel="icon" type="image/png" sizes="32x32" href="./img/favicon-32x32.png" />
    <link rel="icon" type="image/png" sizes="16x16" href="./img/favicon-16x16.png" />
    <link rel="manifest" href="./site.webmanifest" />

     <!-- og tag -->
    <!-- https://ogp.me/ -->
    <meta property="og:title" content="포켓몬 도감" />
    <meta
      property="og:description"
      content="포켓몬 API를 활용해 포켓몬을 알아보자"
    />
    <meta
      property="og:image"
      content="https://parkgoeun00.github.io/250929_fetch/img/preview.png"
    />

    <style>
      /* 폰트 */
      @font-face {
        font-family: "RoundedFixedsys";
        src: url("https://cdn.jsdelivr.net/gh/projectnoonnu/noonfonts_six@1.2/DungGeunMo.woff")
          format("woff");
        font-weight: normal;
        font-display: swap;
      }

      :root {
        --card-bg: #ffffff;
        --body-bg: #f0f2f5;
        --text-color: #333;
        --primary-color: #e3350d;
        --stat-bar-bg: #e0e0e0;
        --hp-color: #ff5959;
        --attack-color: #f5ac78;
        --defense-color: #fae078;
        --special-attack-color: #9db7f5;
        --special-defense-color: #a7db8d;
        --speed-color: #fa92b2;
        --background-color: #f4dc26;
      }

      body {
        font-family: "RoundedFixedsys";
        background-color: var(--background-color);
        color: var(--text-color);
        display: flex;
        flex-direction: column;
        align-items: center;
        margin: 0;
        padding: 20px;
        box-sizing: border-box;
      }

      h1 {
        color: var(--primary-color);
        text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.1);
      }
      .search-section {
        margin-bottom: 20px;
        display: flex;
        gap: 10px;
        align-items: center;
      }
      #pokeId {
        padding: 10px;
        border: 1px solid #ccc;
        border-radius: 5px;
        font-size: 16px;
        width: 100px;
      }
      #pokeBtn {
        padding: 10px 20px;
        border: none;
        border-radius: 5px;
        background-color: var(--primary-color);
        color: white;
        font-size: 16px;
        cursor: pointer;
        transition: background-color 0.3s;
      }
      #pokeBtn:hover {
        background-color: #c02d0b;
      }
      #pokeBox {
        background-color: var(--card-bg);
        border-radius: 15px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        padding: 25px;
        width: 100%;
        max-width: 400px;
        box-sizing: border-box;
        text-align: center;
        transition: all 0.3s ease-in-out;
      }
      #pokeBox.loading {
        filter: blur(5px);
        opacity: 0.7;
      }
      .poke-header {
        margin-bottom: 15px;
      }
      .poke-header h4 {
        margin: 0 0 5px 0;
        font-size: 24px;
      }
      .poke-header h5 {
        margin: 0;
        font-size: 16px;
        color: #777;
        font-style: italic;
      }
      .poke-img {
        width: 150px;
        height: 150px;
        margin: 0 auto;
        image-rendering: pixelated; /* For crisp pixel art */
      }
      .poke-audio {
        width: 80%;
        margin-top: 10px;
      }
      .poke-info {
        text-align: left;
        margin-top: 20px;
      }
      .info-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
        margin-bottom: 15px;
      }
      .info-item h6 {
        margin: 0 0 5px 0;
        color: var(--primary-color);
      }
      .info-item span {
        background-color: #eee;
        padding: 3px 8px;
        border-radius: 12px;
        font-size: 14px;
        margin-right: 5px;
      }
      .poke-description {
        font-style: italic;
        color: #555;
        margin-bottom: 15px;
      }
      .stats-container h6 {
        margin: 0 0 10px 0;
        color: var(--primary-color);
      }
      .stat-item {
        display: flex;
        align-items: center;
        margin-bottom: 8px;
        font-size: 14px;
      }
      .stat-name {
        width: 100px;
        text-transform: capitalize;
      }
      .stat-bar {
        flex-grow: 1;
        height: 15px;
        background-color: var(--stat-bar-bg);
        border-radius: 10px;
        overflow: hidden;
      }
      .stat-value {
        height: 100%;
        color: white;
        font-size: 12px;
        line-height: 15px;
        text-align: center;
        border-radius: 10px;
        transition: width 0.5s ease-in-out;
      }
      .stat-value.hp {
        background-color: var(--hp-color);
      }
      .stat-value.attack {
        background-color: var(--attack-color);
      }
      .stat-value.defense {
        background-color: var(--defense-color);
      }
      .stat-value.special-attack {
        background-color: var(--special-attack-color);
      }
      .stat-value.special-defense {
        background-color: var(--special-defense-color);
      }
      .stat-value.speed {
        background-color: var(--speed-color);
      }
    </style>
  </head>
  <body>
    <h1>포켓몬 도감</h1>
    <section class="search-section">
      <label for="pokeId">포켓몬 ID :</label>
      <input id="pokeId" type="number" min="1" value="1" />
      <button id="pokeBtn">검색</button>
      </section>
      <section id="pokeBox"></section>

      <script>
        const pokeBtn = document.querySelector("#pokeBtn");
        const pokeIdInput = document.querySelector("#pokeId");
        const pokeBox = document.querySelector("#pokeBox");

        const API_BASE_URL = "https://pokeapi.co/api/v2";

        // 데이터 추출 및 가공 함수
        function processPokemonData(data, speciesData) {
          const findKorean = (items, key) => {
            const koreanItem = items.find((v) => v.language.name === "ko");
            return koreanItem ? koreanItem[key] : "정보 없음";
          };

          return {
            id: data.id,
            engName: data.name,
            koName: findKorean(speciesData.names, "name"),
            shape: data.sprites.front_default,
            sound: data.cries.latest,
            types: data.types.map((t) => t.type.name),
            abilities: data.abilities.map((a) => a.ability.name),
            description: findKorean(
              speciesData.flavor_text_entries,
              "flavor_text"
            ),
            stats: data.stats.map((s) => ({
              name: s.stat.name,
              value: s.base_stat,
            })),
          };
        }

        // 데이터 호출 함수
        async function getPokemon(id) {
          if (!id) {
            pokeBox.innerHTML = "<p>포켓몬 ID를 입력해주세요.</p>";
            return;
          }
          pokeBox.innerHTML = "<p>데이터를 불러오는 중...</p>";
          pokeBox.classList.add("loading");

          try {
            const [response, speciesResponse] = await Promise.all([
              fetch(`${API_BASE_URL}/pokemon/${id}`),
              fetch(`${API_BASE_URL}/pokemon-species/${id}`),
            ]);

            if (!response.ok || !speciesResponse.ok) {
              throw new Error("포켓몬 정보를 불러올 수 없습니다.");
            }

            const data = await response.json();
            const speciesData = await speciesResponse.json();

            const poke = processPokemonData(data, speciesData);

            localStorage.setItem("recentPoke", JSON.stringify(poke));
            renderPoke(poke);
          } catch (error) {
            console.error(error);
            pokeBox.innerHTML = `<p>${error.message}</p>`;
          } finally {
            pokeBox.classList.remove("loading");
          }
        }

        // 데이터 화면에 그리기
        function renderPoke(poke) {
          const {
            engName,
            koName,
            shape,
            sound,
            types,
            abilities,
            description,
            stats,
          } = poke;
          pokeBox.innerHTML = `
          <div class="poke-header">
            <h4>${koName}</h4>
            <h5>${engName}</h5>
          </div>
          <img src="${shape}" alt="${koName}" class="poke-img">
          <audio src="${sound}" controls class="poke-audio"></audio>
          <div class="poke-info">
            <p class="poke-description">${description.replace(/\n/g, " ")}</p>
            <div class="info-grid">
              <div class="info-item">
                <h6>타입</h6>
                ${types.map((type) => `<span>${type}</span>`).join("")}
              </div>
              <div class="info-item">
                <h6>특성</h6>
                ${abilities
                  .map((ability) => `<span>${ability}</span>`)
                  .join("")}
              </div>
            </div>
            <div class="stats-container">
              <h6>종족값</h6>
              ${stats
                .map(
                  (stat) => `
                <div class="stat-item">
                  <span class="stat-name">${stat.name}</span>
                  <div class="stat-bar">
                    <div class="stat-value ${
                      stat.name
                    }" style="width: ${Math.min(stat.value / 1.5, 100)}%;">${
                    stat.value
                  }</div>
                  </div>
                </div>
              `
                )
                .join("")}
            </div>
          </div>
        `;
        }

        // 이벤트 리스너
        pokeBtn.addEventListener("click", () => getPokemon(pokeIdInput.value));
        pokeIdInput.addEventListener("keypress", (e) => {
          if (e.key === "Enter") {
            getPokemon(pokeIdInput.value);
          }
        });

        // 직전 검색 데이터 자동 로딩
        document.addEventListener("DOMContentLoaded", () => {
          const rawRecentPoke = localStorage.getItem("recentPoke");
          if (rawRecentPoke) {
            const recentPoke = JSON.parse(rawRecentPoke);
            pokeIdInput.value = recentPoke.id;
            renderPoke(recentPoke);
          } else {
            // 페이지 첫 로딩 시 1번 포켓몬(이상해씨) 정보 표시
            getPokemon(1);
          }
        });
      </script>
    </section>
  </body>
</html>
